<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Snakenlichten</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>
  <body>
    <div id="controls">
      <div class="btn-group btn-group-justified">
        <a id="direction-NW" class="btn btn-default" onclick="snake.direction='NW';">NW</a>
        <a id="direction-NE" class="btn btn-default" onclick="snake.direction='NE';">NE</a>
      </div>
      <div class="btn-group btn-group-justified">
        <a id="direction-W" class="btn btn-default" onclick="snake.direction='W';">W</a>
        <a id="direction-E" class="btn btn-default" onclick="snake.direction='E';">E</a>
      </div>
      <div class="btn-group btn-group-justified">
        <a id="direction-SW" class="btn btn-default" onclick="snake.direction='SW';">SW</a>
        <a id="direction-SE" class="btn btn-default" onclick="snake.direction='SE';">SE</a>
      </div>
    </div>
    <script>
      var width = 1000, height = 1000;
      var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
          .attr("transform", "translate(100,500) scale(1,-1)");

      var board = {
          cells: {},
          edgeLength: 13,
          cellSize: 30,

          draw: function() {
              var edgeLength = board.edgeLength;
              var cellSize = board.cellSize;
              var x = 0;
              var y = 0;
              var rowLength = edgeLength;
              var boardX = 0;
              var boardY = 0;
              for(n = edgeLength; n > 0; n-=2) {
                  for(m = rowLength; m > 0; m-=1) {
                      cell=board.drawCell(x,y,cellSize, boardX, boardY);
                      if (board.cells[boardX] == undefined) {
                        board.cells[boardX] = {};
                      }
                      board.cells[boardX][boardY] = cell;
                      cell.attr("data-board-x", boardX).attr("data-board-y", boardY);
                      x+=1.5*cellSize;
                      boardX += 1;
                  }
                  x=(2+edgeLength-rowLength)*cellSize*0.75;
                  y+=2.5*cellSize;
                  boardY+=1;
                  boardX = boardY;
                  rowLength-=2;
              }
          },
          drawCell: function(x,y,r, boardX, boardY) {
            // var cell = svg.append("circle")
            //   .attr("cx", x)
            //   .attr("cy",y)
            //   .attr("r", r);
            //   return cell;
            var p1,p2,p3;
            if (boardX % 2 == boardY % 2) {
              p1 = x+","+(y+r);
              p2 = (x-r)+","+(y-r);
              p3 = (x+r)+","+(y-r);
            }  else {
              p1 = x+","+(y-r);
              p2 = (x-r)+","+(y+r);
              p3 = (x+r)+","+(y+r);
            }
            return svg.append("polyline")
              .attr("points", p1+" "+p2+" "+p3)
              .attr("stroke-width", "2px")
              .attr("stroke", "black");
          }
      };

      board.draw();

      var snake = {
          headPosition: {
            boardX: 0,
            boardY: 0
          },
          length: 1,
          direction: "E",

          draw: function() {
              svg.selectAll("polyline").attr("fill","black");
              // console.log(snake.headPosition.boardX,snake.headPosition.boardY)
              head = board.cells[snake.headPosition.boardX][snake.headPosition.boardY];
              head.attr("fill","red");
          },

          move: function() {
              switch(snake.direction) {
                case "E":
                    snake.moveRight();
                    break;
                case "W":
                    snake.moveLeft();
                    break;
                case "NE":
                    if (snake.headPosition.boardX % 2 == snake.headPosition.boardY % 2) {
                        snake.moveRight();
                    } else {
                        snake.moveUp();
                    }
                    break;
                case "NW":
                    if (snake.headPosition.boardX % 2 == snake.headPosition.boardY % 2) {
                        snake.moveLeft();
                    } else {
                        snake.moveUp();
                    }
                    break;
                case "SE":
                    if (snake.headPosition.boardX % 2 == snake.headPosition.boardY % 2) {
                        snake.moveDown();
                    } else {
                        snake.moveRight();
                    }
                    break;
                case "SW":
                    if (snake.headPosition.boardX % 2 == snake.headPosition.boardY % 2) {
                        snake.moveDown();
                    } else {
                        snake.moveLeft();
                    }
                    break;
              }
          },
          moveRight: function() {
            if (board.cells[snake.headPosition.boardX+1] && board.cells[snake.headPosition.boardX+1][snake.headPosition.boardY]) {
              snake.headPosition.boardX += 1;
            }
            // else {
            //   snake.headPosition.boardX = snake.headPosition.boardY;
            // }
          },
          moveLeft: function() {
            if (board.cells[snake.headPosition.boardX-1] && board.cells[snake.headPosition.boardX-1][snake.headPosition.boardY]) {
              snake.headPosition.boardX -= 1;
            }
            // else {
            //   snake.headPosition.boardX = board.edgeLength-1-snake.headPosition.boardY;
            // }
          },
          moveUp: function() {
            if (board.cells[snake.headPosition.boardX] && board.cells[snake.headPosition.boardX][snake.headPosition.boardY+1]) {
              snake.headPosition.boardY += 1;
            }
            //TODO: wrap
          },
          moveDown: function() {
            if (board.cells[snake.headPosition.boardX] && board.cells[snake.headPosition.boardX][snake.headPosition.boardY-1]) {
              snake.headPosition.boardY -= 1;
            }
            //TODO: wrap
          },

          run: function() {
              var t = d3.interval(function(elapsed) {
                  d3.selectAll("#controls .btn").classed("active", false);
                  d3.select("#direction-"+snake.direction).classed("active", true);
                  snake.draw();
                  snake.move();
              }, 500);
          }
      }

      snake.run()

    </script>
  </body>
</html>
